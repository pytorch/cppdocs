


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Program Listing for File library.h &mdash; PyTorch master documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://pytorch.org/docs/stable/api/program_listing_file_torch_library.h.html"/>
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../_static/cpp_theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/collapsible-lists/css/tree_view.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <!-- Google Analytics -->
  
  <!-- End Google Analytics -->
  

  
  <script src="../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="active docs-active">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/audio/stable/index.html">
                  <span class="dropdown-title">torchaudio</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/text/stable/index.html">
                  <span class="dropdown-title">torchtext</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/vision/stable/index.html">
                  <span class="dropdown-title">torchvision</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torcharrow">
                  <span class="dropdown-title">torcharrow</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/data">
                  <span class="dropdown-title">TorchData</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchrec">
                  <span class="dropdown-title">TorchRec</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/serve/">
                  <span class="dropdown-title">TorchServe</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchx/">
                  <span class="dropdown-title">TorchX</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/xla">
                  <span class="dropdown-title">PyTorch on XLA Devices</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about PyTorch’s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/foundation">
                  <span class="dropdown-title">PyTorch Foundation</span>
                  <p>Learn about the PyTorch foundation</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/community-stories">
                  <span class="dropdown-title">Community Stories</span>
                  <p>Learn how our community solves real, everyday machine learning problems with PyTorch.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/events">
                  <span class="dropdown-title">Events</span>
                  <p>Find events, webinars, and podcasts</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/hub">
                  <span class="dropdown-title">Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
                <div class="version">
                  master
                </div>
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../installing.html">Installing C++ Distributions of PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../frontend.html">The C++ Frontend</a></li>
<li class="toctree-l1"><a class="reference internal" href="library_root.html">Library API</a></li>
</ul>
<p class="caption"><span class="caption-text">Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../notes/faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/inference_mode.html">Inference Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/maybe_owned.html">MaybeOwned&lt;Tensor&gt;</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/tensor_basics.html">Tensor Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/tensor_creation.html">Tensor Creation API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/tensor_cuda_stream.html">Tensor CUDA Stream API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/tensor_indexing.html">Tensor Indexing API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/versioning.html">Library Versioning</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
      <li>Program Listing for File library.h</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
            
            
              <!-- User defined GitHub URL -->
              <a href="https://github.com/pytorch/pytorch" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <div class="section" id="program-listing-for-file-library-h">
<span id="program-listing-file-torch-library-h"></span><h1>Program Listing for File library.h<a class="headerlink" href="#program-listing-for-file-library-h" title="Permalink to this headline">¶</a></h1>
<p>↰ <a class="reference internal" href="file_torch_library.h.html#file-torch-library-h"><span class="std std-ref">Return to documentation for file</span></a> (<code class="docutils literal notranslate"><span class="pre">torch/library.h</span></code>)</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// m is a torch::Library; methods on it will define</span>
<span class="w">  </span><span class="c1">// operators in the myops namespace</span>
<span class="w">  </span><span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;add&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">add_impl</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="n">m</span><span class="p">.</span><span class="n">fallback</span><span class="p">(</span><span class="n">xla_fallback</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// m is a torch::Library; methods on it will define</span>
<span class="w">  </span><span class="c1">// CPU implementations of operators in the myops namespace.</span>
<span class="w">  </span><span class="c1">// It is NOT valid to call torch::Library::def()</span>
<span class="w">  </span><span class="c1">// in this context.</span>
<span class="w">  </span><span class="n">m</span><span class="p">.</span><span class="n">impl</span><span class="p">(</span><span class="s">&quot;add&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">add_cpu_impl</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="c1">// You must define all of the operators for this library in</span>
<span class="c1">// this namespace.</span>
<span class="n">TORCH_LIBRARY</span><span class="p">(</span><span class="n">myops</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Define a operator with exactly one implementation for all backends.</span>
<span class="w">  </span><span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;add(Tensor self, Tensor other) -&gt; Tensor&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">add_impl</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Define a schema for an operator, but provide no implementation</span>
<span class="w">  </span><span class="c1">// (use this syntax if you want to use the dispatcher)</span>
<span class="w">  </span><span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;mul(Tensor self, Tensor other) -&gt; Tensor&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Provide an implementation for a defined operator (you can</span>
<span class="w">  </span><span class="c1">// provide multiple; one per backend).  The dispatcher takes care of</span>
<span class="w">  </span><span class="c1">// calling the correct implementation depending on if we get a CPU</span>
<span class="w">  </span><span class="c1">// tensor or a CUDA tensor</span>
<span class="w">  </span><span class="n">m</span><span class="p">.</span><span class="n">impl</span><span class="p">(</span><span class="s">&quot;mul&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">torch</span><span class="o">::</span><span class="n">kCPU</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mul_cpu_impl</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">m</span><span class="p">.</span><span class="n">impl</span><span class="p">(</span><span class="s">&quot;mul&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">torch</span><span class="o">::</span><span class="n">kCUDA</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mul_cuda_impl</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Define implementations for operators for a non-standard backend,</span>
<span class="c1">// e.g., XLA (valid values are entries of DispatchKey).  This can</span>
<span class="c1">// be used to define operators in a different file than the initial</span>
<span class="c1">// TORCH_LIBRARY definition (e.g., if it is in an external library)</span>
<span class="n">TORCH_LIBRARY_IMPL</span><span class="p">(</span><span class="n">myops</span><span class="p">,</span><span class="w"> </span><span class="n">XLA</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">m</span><span class="p">.</span><span class="n">impl</span><span class="p">(</span><span class="s">&quot;mul&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mul_xla_impl</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cp">#pragma once</span>


<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ATen/core/op_registration/infer_schema.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ATen/core/op_registration/op_allowlist.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;c10/core/DispatchKey.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;torch/csrc/jit/frontend/function_schema_parser.h&gt;</span><span class="cp"></span>

<span class="c1">// Just for inferFunctionSchemaFromFunctor</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ATen/core/op_registration/op_registration.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ATen/core/enum_tag.h&gt;</span><span class="cp"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="cp">#if defined C10_MOBILE</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">NoInferSchemaTag</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="c1">// For multipy/torchdeploy use case</span>
<span class="k">enum</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">_RegisterOrVerify</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">REGISTER</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">VERIFY</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">CurClass</span><span class="o">&gt;</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">class_</span><span class="p">;</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">TORCH_API</span><span class="w"> </span><span class="n">CppFunction</span><span class="w"> </span><span class="k">final</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// TODO: This is morally the same thing as KernelRegistrationConfig, but it&#39;s</span>
<span class="w">  </span><span class="c1">// opaque to the user.</span>

<span class="w"> </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Func</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="k">explicit</span><span class="w"> </span><span class="n">CppFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">Func</span><span class="o">*</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">enable_if_t</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">          </span><span class="n">c10</span><span class="o">::</span><span class="n">guts</span><span class="o">::</span><span class="n">is_function_type</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">nullptr_t</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="n">func_</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">KernelFunction</span><span class="o">::</span><span class="n">makeFromUnboxedRuntimeFunction</span><span class="p">(</span><span class="n">f</span><span class="p">)),</span><span class="w"></span>
<span class="w">        </span><span class="n">cpp_signature_</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">impl</span><span class="o">::</span><span class="n">CppSignature</span><span class="o">::</span><span class="n">make</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&gt;</span><span class="p">()),</span><span class="w"></span>
<span class="w">        </span><span class="n">schema_</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">c10</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">inferFunctionSchemaFromFunctor</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">decay_t</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&gt;&gt;</span><span class="p">()),</span><span class="w"></span>
<span class="w">        </span><span class="n">debug_</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">FuncPtr</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="k">explicit</span><span class="w"> </span><span class="n">CppFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">FuncPtr</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">enable_if_t</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">          </span><span class="n">c10</span><span class="o">::</span><span class="n">is_compile_time_function_pointer</span><span class="o">&lt;</span><span class="n">FuncPtr</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">nullptr_t</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="n">func_</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">KernelFunction</span><span class="o">::</span><span class="n">makeFromUnboxedFunction</span><span class="p">(</span><span class="n">f</span><span class="p">)),</span><span class="w"></span>
<span class="w">        </span><span class="n">cpp_signature_</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">c10</span><span class="o">::</span><span class="n">impl</span><span class="o">::</span><span class="n">CppSignature</span><span class="o">::</span><span class="n">make</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">FuncPtr</span><span class="o">::</span><span class="n">FuncType</span><span class="o">&gt;</span><span class="p">()),</span><span class="w"></span>
<span class="w">        </span><span class="n">schema_</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">inferFunctionSchemaFromFunctor</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">                </span><span class="k">typename</span><span class="w"> </span><span class="nc">FuncPtr</span><span class="o">::</span><span class="n">FuncType</span><span class="o">&gt;</span><span class="p">()),</span><span class="w"></span>
<span class="w">        </span><span class="n">debug_</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Lambda</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="k">explicit</span><span class="w"> </span><span class="n">CppFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">Lambda</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">enable_if_t</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">          </span><span class="n">c10</span><span class="o">::</span><span class="n">guts</span><span class="o">::</span><span class="n">is_functor</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">decay_t</span><span class="o">&lt;</span><span class="n">Lambda</span><span class="o">&gt;&gt;::</span><span class="n">value</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">nullptr_t</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="n">func_</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">KernelFunction</span><span class="o">::</span><span class="n">makeFromUnboxedLambda</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Lambda</span><span class="o">&gt;</span><span class="p">(</span><span class="n">f</span><span class="p">))),</span><span class="w"></span>
<span class="w">        </span><span class="n">cpp_signature_</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">impl</span><span class="o">::</span><span class="n">CppSignature</span><span class="o">::</span><span class="n">make</span><span class="o">&lt;</span><span class="n">Lambda</span><span class="o">&gt;</span><span class="p">()),</span><span class="w"></span>
<span class="w">        </span><span class="n">schema_</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">inferFunctionSchemaFromFunctor</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">decay_t</span><span class="o">&lt;</span><span class="n">Lambda</span><span class="o">&gt;&gt;</span><span class="p">()),</span><span class="w"></span>
<span class="w">        </span><span class="n">debug_</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="cp">#if defined C10_MOBILE</span>
<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Func</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="k">explicit</span><span class="w"> </span><span class="n">CppFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">Func</span><span class="o">*</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">NoInferSchemaTag</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">enable_if_t</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">          </span><span class="n">c10</span><span class="o">::</span><span class="n">guts</span><span class="o">::</span><span class="n">is_function_type</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">nullptr_t</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="n">func_</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">KernelFunction</span><span class="o">::</span><span class="n">makeFromUnboxedRuntimeFunction</span><span class="p">(</span><span class="n">f</span><span class="p">)),</span><span class="w"></span>
<span class="w">        </span><span class="n">cpp_signature_</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">impl</span><span class="o">::</span><span class="n">CppSignature</span><span class="o">::</span><span class="n">make</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&gt;</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="c1">// TODO: Don&#39;t go through WrapRuntimeKernelFunctor</span>
<span class="w">        </span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">schema_</span><span class="p">(</span><span class="k">nullptr</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">debug_</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">FuncPtr</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="k">explicit</span><span class="w"> </span><span class="n">CppFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">FuncPtr</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">NoInferSchemaTag</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">enable_if_t</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">          </span><span class="n">c10</span><span class="o">::</span><span class="n">is_compile_time_function_pointer</span><span class="o">&lt;</span><span class="n">FuncPtr</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">nullptr_t</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="n">func_</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">KernelFunction</span><span class="o">::</span><span class="n">makeFromUnboxedFunction</span><span class="p">(</span><span class="n">f</span><span class="p">)),</span><span class="w"></span>
<span class="w">        </span><span class="n">cpp_signature_</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">c10</span><span class="o">::</span><span class="n">impl</span><span class="o">::</span><span class="n">CppSignature</span><span class="o">::</span><span class="n">make</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">FuncPtr</span><span class="o">::</span><span class="n">FuncType</span><span class="o">&gt;</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="c1">// TODO: Don&#39;t go through WrapRuntimeKernelFunctor</span>
<span class="w">        </span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">schema_</span><span class="p">(</span><span class="k">nullptr</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">debug_</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Lambda</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="k">explicit</span><span class="w"> </span><span class="n">CppFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">Lambda</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">NoInferSchemaTag</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">enable_if_t</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">          </span><span class="n">c10</span><span class="o">::</span><span class="n">guts</span><span class="o">::</span><span class="n">is_functor</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">decay_t</span><span class="o">&lt;</span><span class="n">Lambda</span><span class="o">&gt;&gt;::</span><span class="n">value</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">nullptr_t</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="n">func_</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">KernelFunction</span><span class="o">::</span><span class="n">makeFromUnboxedLambda</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Lambda</span><span class="o">&gt;</span><span class="p">(</span><span class="n">f</span><span class="p">))),</span><span class="w"></span>
<span class="w">        </span><span class="n">cpp_signature_</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">impl</span><span class="o">::</span><span class="n">CppSignature</span><span class="o">::</span><span class="n">make</span><span class="o">&lt;</span><span class="n">Lambda</span><span class="o">&gt;</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="c1">// TODO: Don&#39;t go through WrapRuntimeKernelFunctor</span>
<span class="w">        </span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">schema_</span><span class="p">(</span><span class="k">nullptr</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">debug_</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">  </span><span class="o">~</span><span class="n">CppFunction</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="n">CppFunction</span><span class="p">(</span><span class="n">CppFunction</span><span class="o">&amp;&amp;</span><span class="p">)</span><span class="w"> </span><span class="k">noexcept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">CppFunction</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">CppFunction</span><span class="o">&amp;&amp;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">CppFunction</span><span class="w"> </span><span class="nf">makeFromBoxedKernel</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">BoxedKernel</span><span class="w"> </span><span class="n">kernel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">CppFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">c10</span><span class="o">::</span><span class="n">KernelFunction</span><span class="o">::</span><span class="n">makeFromBoxedKernel</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">kernel</span><span class="p">)),</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* cpp_signature */</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">nullopt</span><span class="p">,</span><span class="w"> </span><span class="c1">// not known for boxed functions</span>
<span class="w">        </span><span class="cm">/* schema */</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">CppFunction</span><span class="w"> </span><span class="nf">makeFallthrough</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">makeFromBoxedKernel</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">BoxedKernel</span><span class="o">::</span><span class="n">makeFallthrough</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">CppFunction</span><span class="w"> </span><span class="nf">makeNamedNotSupported</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">makeFromBoxedKernel</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">BoxedKernel</span><span class="o">::</span><span class="n">makeNamedNotSupported</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="n">c10</span><span class="o">::</span><span class="n">BoxedKernel</span><span class="o">::</span><span class="n">BoxedKernelFunction</span><span class="o">*</span><span class="w"> </span><span class="n">func</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">CppFunction</span><span class="w"> </span><span class="n">makeFromBoxedFunction</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">makeFromBoxedKernel</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">c10</span><span class="o">::</span><span class="n">BoxedKernel</span><span class="o">::</span><span class="n">makeFromFunction</span><span class="o">&lt;</span><span class="n">func</span><span class="o">&gt;</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Variant that takes in a boxed kernel function with a plumbed</span>
<span class="w">  </span><span class="c1">// DispatchKeySet. See Note [Plumbing Keys Through The Dispatcher] for</span>
<span class="w">  </span><span class="c1">// details.</span>
<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="n">c10</span><span class="o">::</span><span class="n">BoxedKernel</span><span class="o">::</span><span class="n">BoxedKernelFunction_withDispatchKeys</span><span class="o">*</span><span class="w"> </span><span class="n">func</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">CppFunction</span><span class="w"> </span><span class="n">makeFromBoxedFunction</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">makeFromBoxedKernel</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">c10</span><span class="o">::</span><span class="n">BoxedKernel</span><span class="o">::</span><span class="n">makeFromFunction</span><span class="o">&lt;</span><span class="n">func</span><span class="o">&gt;</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">KernelFunctor</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">CppFunction</span><span class="w"> </span><span class="n">makeFromBoxedFunctor</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">KernelFunctor</span><span class="o">&gt;</span><span class="w"> </span><span class="n">kernelFunctor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">makeFromBoxedKernel</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">c10</span><span class="o">::</span><span class="n">BoxedKernel</span><span class="o">::</span><span class="n">makeFromFunctor</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">kernelFunctor</span><span class="p">)));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="w"></span>
<span class="w">      </span><span class="k">typename</span><span class="w"> </span><span class="nc">FuncPtr</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">enable_if_t</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">          </span><span class="n">c10</span><span class="o">::</span><span class="n">guts</span><span class="o">::</span><span class="n">is_function_type</span><span class="o">&lt;</span><span class="n">FuncPtr</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">nullptr_t</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">CppFunction</span><span class="w"> </span><span class="n">makeFromUnboxedFunction</span><span class="p">(</span><span class="n">FuncPtr</span><span class="o">*</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">CppFunction</span><span class="p">(</span><span class="n">f</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="w"></span>
<span class="w">      </span><span class="k">typename</span><span class="w"> </span><span class="nc">FuncPtr</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">enable_if_t</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">          </span><span class="n">c10</span><span class="o">::</span><span class="n">is_compile_time_function_pointer</span><span class="o">&lt;</span><span class="n">FuncPtr</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">nullptr_t</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">CppFunction</span><span class="w"> </span><span class="n">makeFromUnboxedFunction</span><span class="p">(</span><span class="n">FuncPtr</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">CppFunction</span><span class="p">(</span><span class="n">f</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">CppFunction</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">debug</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">debug_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">d</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w"> </span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="n">c10</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">c10</span><span class="o">::</span><span class="n">DispatchKey</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dispatch_key_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">c10</span><span class="o">::</span><span class="n">KernelFunction</span><span class="w"> </span><span class="n">func_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">c10</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">c10</span><span class="o">::</span><span class="n">impl</span><span class="o">::</span><span class="n">CppSignature</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cpp_signature_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">c10</span><span class="o">::</span><span class="n">FunctionSchema</span><span class="o">&gt;</span><span class="w"> </span><span class="n">schema_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">debug_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// The &quot;setter&quot; for dispatch_key_</span>
<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Func</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="k">friend</span><span class="w"> </span><span class="n">CppFunction</span><span class="w"> </span><span class="n">dispatch</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">DispatchKey</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="o">&amp;&amp;</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="c1">// The only class which actually pulls out values from CppFunction (does so</span>
<span class="w">  </span><span class="c1">// destructively, felt too lazy to write accessors that I don&#39;t even</span>
<span class="w">  </span><span class="c1">// want users to use)</span>
<span class="w">  </span><span class="k">friend</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Library</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">CppFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">c10</span><span class="o">::</span><span class="n">KernelFunction</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">c10</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">c10</span><span class="o">::</span><span class="n">impl</span><span class="o">::</span><span class="n">CppSignature</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cpp_signature</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">c10</span><span class="o">::</span><span class="n">FunctionSchema</span><span class="o">&gt;</span><span class="w"> </span><span class="n">schema</span><span class="p">);</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>


<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Func</span><span class="o">&gt;</span><span class="w"></span>
<span class="kr">inline</span><span class="w"> </span><span class="n">CppFunction</span><span class="w"> </span><span class="n">dispatch</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">DispatchKey</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">raw_f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">CppFunction</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&gt;</span><span class="p">(</span><span class="n">raw_f</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">DispatchKey</span><span class="o">::</span><span class="n">CatchAll</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">f</span><span class="p">.</span><span class="n">dispatch_key_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">f</span><span class="p">.</span><span class="n">dispatch_key_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">f</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Func</span><span class="o">&gt;</span><span class="w"></span>
<span class="kr">inline</span><span class="w"> </span><span class="n">CppFunction</span><span class="w"> </span><span class="n">dispatch</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">DeviceType</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">raw_f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">deviceTypeToDispatchKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[](</span><span class="n">c10</span><span class="o">::</span><span class="n">DeviceType</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// This list is synchronized with the k-constants in c10/core/DeviceType.h</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">c10</span><span class="o">::</span><span class="no">DeviceType</span><span class="o">::</span><span class="no">CPU</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">DispatchKey</span><span class="o">::</span><span class="n">CPU</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">c10</span><span class="o">::</span><span class="no">DeviceType</span><span class="o">::</span><span class="no">CUDA</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">DispatchKey</span><span class="o">::</span><span class="n">CUDA</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">c10</span><span class="o">::</span><span class="no">DeviceType</span><span class="o">::</span><span class="no">IPU</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">DispatchKey</span><span class="o">::</span><span class="n">IPU</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">c10</span><span class="o">::</span><span class="no">DeviceType</span><span class="o">::</span><span class="no">XLA</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">DispatchKey</span><span class="o">::</span><span class="n">XLA</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">c10</span><span class="o">::</span><span class="no">DeviceType</span><span class="o">::</span><span class="no">Lazy</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">DispatchKey</span><span class="o">::</span><span class="n">Lazy</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">c10</span><span class="o">::</span><span class="no">DeviceType</span><span class="o">::</span><span class="no">XPU</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">DispatchKey</span><span class="o">::</span><span class="n">XPU</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">c10</span><span class="o">::</span><span class="no">DeviceType</span><span class="o">::</span><span class="no">MPS</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">DispatchKey</span><span class="o">::</span><span class="n">MPS</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">c10</span><span class="o">::</span><span class="no">DeviceType</span><span class="o">::</span><span class="no">Meta</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">DispatchKey</span><span class="o">::</span><span class="n">Meta</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">c10</span><span class="o">::</span><span class="no">DeviceType</span><span class="o">::</span><span class="no">HIP</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">DispatchKey</span><span class="o">::</span><span class="n">HIP</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">c10</span><span class="o">::</span><span class="no">DeviceType</span><span class="o">::</span><span class="no">ORT</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">DispatchKey</span><span class="o">::</span><span class="n">ORT</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">c10</span><span class="o">::</span><span class="no">DeviceType</span><span class="o">::</span><span class="no">HPU</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">DispatchKey</span><span class="o">::</span><span class="n">HPU</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">c10</span><span class="o">::</span><span class="no">DeviceType</span><span class="o">::</span><span class="no">MTIA</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">DispatchKey</span><span class="o">::</span><span class="n">MTIA</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">c10</span><span class="o">::</span><span class="no">DeviceType</span><span class="o">::</span><span class="no">PrivateUse1</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">DispatchKey</span><span class="o">::</span><span class="n">PrivateUse1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="n">TORCH_CHECK</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="nb">false</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;Device type &quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">t</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot; cannot be overloaded at dispatch time, &quot;</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;please file a bug report explaining what you were trying to do.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">dispatch</span><span class="p">(</span><span class="n">deviceTypeToDispatchKey</span><span class="p">(</span><span class="n">type</span><span class="p">),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&gt;</span><span class="p">(</span><span class="n">raw_f</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="kr">inline</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">FunctionSchema</span><span class="w"> </span><span class="n">schema</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">AliasAnalysisKind</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">c10</span><span class="o">::</span><span class="n">FunctionSchema</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">torch</span><span class="o">::</span><span class="n">jit</span><span class="o">::</span><span class="n">parseSchema</span><span class="p">(</span><span class="n">str</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">s</span><span class="p">.</span><span class="n">setAliasAnalysis</span><span class="p">(</span><span class="n">k</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">s</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">inline</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">FunctionSchema</span><span class="w"> </span><span class="n">schema</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">schema</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">AliasAnalysisKind</span><span class="o">::</span><span class="n">FROM_SCHEMA</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">inline</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">FunctionSchema</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">schema</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">FunctionSchema</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">detail</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="kr">inline</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">either</span><span class="o">&lt;</span><span class="n">c10</span><span class="o">::</span><span class="n">OperatorName</span><span class="p">,</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">FunctionSchema</span><span class="o">&gt;</span><span class="w"> </span><span class="n">constructSchemaOrName</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">c10</span><span class="o">::</span><span class="n">FunctionSchema</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">make_right</span><span class="o">&lt;</span><span class="n">c10</span><span class="o">::</span><span class="n">OperatorName</span><span class="p">,</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">FunctionSchema</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">s</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="kr">inline</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">either</span><span class="o">&lt;</span><span class="n">c10</span><span class="o">::</span><span class="n">OperatorName</span><span class="p">,</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">FunctionSchema</span><span class="o">&gt;</span><span class="w"> </span><span class="n">constructSchemaOrName</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">c10</span><span class="o">::</span><span class="n">OperatorName</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">make_left</span><span class="o">&lt;</span><span class="n">c10</span><span class="o">::</span><span class="n">OperatorName</span><span class="p">,</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">FunctionSchema</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">n</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="kr">inline</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">either</span><span class="o">&lt;</span><span class="n">c10</span><span class="o">::</span><span class="n">OperatorName</span><span class="p">,</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">FunctionSchema</span><span class="o">&gt;</span><span class="w"> </span><span class="n">constructSchemaOrName</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">torch</span><span class="o">::</span><span class="n">jit</span><span class="o">::</span><span class="n">parseSchemaOrName</span><span class="p">(</span><span class="n">str</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">is_right</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">right</span><span class="p">().</span><span class="n">setAliasAnalysis</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">AliasAnalysisKind</span><span class="o">::</span><span class="n">FROM_SCHEMA</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">s</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">TorchLibraryInit</span><span class="p">;</span><span class="w"></span>

<span class="p">}</span><span class="w"> </span><span class="c1">// namespace detail</span>

<span class="c1">// Note [Selective build]</span>
<span class="c1">// ~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="c1">// In some settings, especially mobile, it is important to avoid compiling any</span>
<span class="c1">// references to functions that you aren&#39;t actually going to use, so that they</span>
<span class="c1">// can be eliminated by the linker.  We call this capability &quot;selective build&quot;.</span>
<span class="c1">//</span>
<span class="c1">// A very easy way to implement selective build which results in a lot of</span>
<span class="c1">// boilerplate is to just add ifdef&#39;s around every registration call, but this</span>
<span class="c1">// means you have to write a lot of extra lines of code at every registration</span>
<span class="c1">// site, and it also means you have to define some munging scheme to map</span>
<span class="c1">// operators to macros.</span>
<span class="c1">//</span>
<span class="c1">// Instead of doing this, we have a different mechanism centered around the</span>
<span class="c1">// concept of a SelectiveStr.  A selective name is like a const char* string,</span>
<span class="c1">// except it also carries at compile time a boolean saying whether or not a</span>
<span class="c1">// registration should actually happen or not.  We then have extra overloads</span>
<span class="c1">// which bypass registration entirely if a selective name is disabled.  We do a</span>
<span class="c1">// constexpr test to see if a operator should be enabled or not; this is</span>
<span class="c1">// currently implemented in ATen/core/op_registration/op_allowlist.h</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">detail</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="c1">// dummy class for non selected custom torchbind classes</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ClassNotSelected</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w"> </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="n">ClassNotSelected</span><span class="o">&amp;</span><span class="w"> </span><span class="n">def_pickle</span><span class="p">(...)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">ClassNotSelected</span><span class="o">&amp;</span><span class="w"> </span><span class="n">def</span><span class="p">(...)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="c1">// A SelectiveStr is like a const char*, except that it also comes</span>
<span class="c1">// with a type brand that says whether or not the name is enabled or</span>
<span class="c1">// not.  If the string is disabled, then (at compile time) we DON&#39;T generate</span>
<span class="c1">// a registration call for it.  This class is not intended to be called</span>
<span class="c1">// directly; use TORCH_SELECTIVE_NAME or TORCH_SELECTIVE_SCHEMA macros below</span>
<span class="c1">// to create it.</span>
<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">bool</span><span class="w"> </span><span class="n">enabled</span><span class="o">&gt;</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">SelectiveStr</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w"> </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="k">explicit</span><span class="w"> </span><span class="n">SelectiveStr</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">name_</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">name_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w"> </span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">name_</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="cp">#define TORCH_SELECTIVE_CLASS(n) \</span>
<span class="cp">  torch::detail::SelectiveStr&lt;c10::impl::custom_class_allowlist_check(n)&gt;(n)</span>
<span class="cp">#define TORCH_SELECTIVE_NAME(n) \</span>
<span class="cp">  torch::detail::SelectiveStr&lt;c10::impl::op_allowlist_check(n)&gt;(n)</span>
<span class="cp">#define TORCH_SELECTIVE_SCHEMA(n) \</span>
<span class="cp">  torch::detail::SelectiveStr&lt;c10::impl::schema_allowlist_check(n)&gt;(n)</span>

<span class="p">}</span><span class="w"> </span><span class="c1">// namespace detail</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TORCH_API</span><span class="w"> </span><span class="n">Library</span><span class="w"> </span><span class="k">final</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w"> </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="k">enum</span><span class="w"> </span><span class="nc">Kind</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">DEF</span><span class="p">,</span><span class="w"> </span><span class="c1">// from TORCH_LIBRARY (no qualifier)</span>
<span class="w">    </span><span class="n">IMPL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">FRAGMENT</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">};</span><span class="w"></span>

<span class="w">  </span><span class="n">Library</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">Kind</span><span class="w"> </span><span class="n">kind</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">ns</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">c10</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">c10</span><span class="o">::</span><span class="n">DispatchKey</span><span class="o">&gt;</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">line</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">Library</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Library</span><span class="o">&amp;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">delete</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Library</span><span class="o">&amp;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">delete</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="p">(</span><span class="n">Library</span><span class="o">&amp;&amp;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">Library</span><span class="o">&amp;&amp;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Some notes about the API design here.  We had the following constraints:</span>
<span class="w">  </span><span class="c1">//</span>
<span class="w">  </span><span class="c1">//  - We need to support multiple &quot;types&quot; of arguments for schema and</span>
<span class="w">  </span><span class="c1">//    functions (e.g., unnamed lambda types, regular functions, const char*,</span>
<span class="w">  </span><span class="c1">//    fully instantiated schemas)</span>
<span class="w">  </span><span class="c1">//  - We don&#39;t want to write exponentially many overloads</span>
<span class="w">  </span><span class="c1">//  - We don&#39;t want to rely on implicit conversion to a common type,</span>
<span class="w">  </span><span class="c1">//    because the C++ compiler will only be willing to do a single</span>
<span class="w">  </span><span class="c1">//    implicit conversion (reducing the set of valid types which you</span>
<span class="w">  </span><span class="c1">//    can invoke with); also error messages are worse when an implicit</span>
<span class="w">  </span><span class="c1">//    conversion is not selected (as the compiler will not explain</span>
<span class="w">  </span><span class="c1">//    why it didn&#39;t select an implicit conversion; this is different</span>
<span class="w">  </span><span class="c1">//    from overloads where it will explain each candidate overload and</span>
<span class="w">  </span><span class="c1">//    why it didn&#39;t apply)</span>
<span class="w">  </span><span class="c1">//</span>
<span class="w">  </span><span class="c1">// To solve all of these constraints at the same time, we use a trick taken</span>
<span class="w">  </span><span class="c1">// from the pybind11 library: template over the argument in the user visible</span>
<span class="w">  </span><span class="c1">// API, and inside of the templated function explicitly call an overloaded</span>
<span class="w">  </span><span class="c1">// function to resolve the argument to a real type.  You get the good error</span>
<span class="w">  </span><span class="c1">// messages from overloads, but at the same time you only need to write the</span>
<span class="w">  </span><span class="c1">// overload for any given argument type once.</span>


<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Schema</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="n">def</span><span class="p">(</span><span class="n">Schema</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">raw_schema</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">at</span><span class="o">::</span><span class="n">Tag</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="n">_RegisterOrVerify</span><span class="w"> </span><span class="n">rv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_RegisterOrVerify</span><span class="o">::</span><span class="n">REGISTER</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">c10</span><span class="o">::</span><span class="n">FunctionSchema</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">schema</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Schema</span><span class="o">&gt;</span><span class="p">(</span><span class="n">raw_schema</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">_def</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="n">tags</span><span class="p">,</span><span class="w"> </span><span class="n">rv</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">NameOrSchema</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">Func</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="n">def</span><span class="p">(</span><span class="n">NameOrSchema</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">raw_name_or_schema</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">raw_f</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">CppFunction</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&gt;</span><span class="p">(</span><span class="n">raw_f</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">name_or_schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">constructSchemaOrName</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">NameOrSchema</span><span class="o">&gt;</span><span class="p">(</span><span class="n">raw_name_or_schema</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">_def</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">name_or_schema</span><span class="p">),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">f</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Name</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">Func</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="n">impl</span><span class="p">(</span><span class="n">Name</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">raw_f</span><span class="p">,</span><span class="w"> </span><span class="n">_RegisterOrVerify</span><span class="w"> </span><span class="n">rv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_RegisterOrVerify</span><span class="o">::</span><span class="n">REGISTER</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// TODO: need to raise an error when you impl a function that has a</span>
<span class="w">    </span><span class="c1">// catch all def</span>
<span class="cp">#if defined C10_MOBILE</span>
<span class="w">    </span><span class="n">CppFunction</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&gt;</span><span class="p">(</span><span class="n">raw_f</span><span class="p">),</span><span class="w"> </span><span class="n">NoInferSchemaTag</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">CppFunction</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&gt;</span><span class="p">(</span><span class="n">raw_f</span><span class="p">));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">_impl</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">f</span><span class="p">),</span><span class="w"> </span><span class="n">rv</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="cp">#if defined C10_MOBILE</span>
<span class="w">  </span><span class="c1">// Note: This overload is needed only for C10_MOBILE, since the automatically</span>
<span class="w">  </span><span class="c1">// defined copy constructor for the CppFunction doesn&#39;t have the additional</span>
<span class="w">  </span><span class="c1">// NoInferSchemaTag argument. We define the overload for the impl() function</span>
<span class="w">  </span><span class="c1">// to accept a CppFunction&amp;&amp; argument. The already constructed CppFunction</span>
<span class="w">  </span><span class="c1">// object may or may not have the inferred schema, but it doesn&#39;t matter</span>
<span class="w">  </span><span class="c1">// for our purposes since if it already has the inferred schema, then we</span>
<span class="w">  </span><span class="c1">// might as well just pass it through directly.</span>
<span class="w">  </span><span class="c1">//</span>
<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Name</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="n">impl</span><span class="p">(</span><span class="n">Name</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">CppFunction</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">raw_f</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// TODO: need to raise an error when you impl a function that has a</span>
<span class="w">    </span><span class="c1">// catch all def</span>
<span class="w">    </span><span class="n">CppFunction</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">CppFunction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">raw_f</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">_impl</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">f</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">  </span><span class="c1">// Helper for getting an OperatorName for a const char*.  You probably</span>
<span class="w">  </span><span class="c1">// don&#39;t need this.</span>
<span class="w">  </span><span class="n">c10</span><span class="o">::</span><span class="n">OperatorName</span><span class="w"> </span><span class="n">_resolve</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Name</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">Dispatch</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">Func</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="n">impl</span><span class="p">(</span><span class="n">Name</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">Dispatch</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">raw_f</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">impl</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">dispatch</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Dispatch</span><span class="o">&gt;</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&gt;</span><span class="p">(</span><span class="n">raw_f</span><span class="p">)));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Name</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">Func</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="n">impl_UNBOXED</span><span class="p">(</span><span class="n">Name</span><span class="w"> </span><span class="cm">/*name*/</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="o">*</span><span class="w"> </span><span class="cm">/*raw_f*/</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">static_assert</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">c10</span><span class="o">::</span><span class="n">guts</span><span class="o">::</span><span class="n">false_t</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;.impl_UNBOXED(...) was removed. Please use .impl(...) instead.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// These overloads cover cases when a SelectiveStr (see Note [Selective</span>
<span class="w">  </span><span class="c1">// build]) has been disabled at compile time.  In that case, don&#39;t generate</span>
<span class="w">  </span><span class="c1">// any code referencing the passed in functions at all.</span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="n">def</span><span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">SelectiveStr</span><span class="o">&lt;</span><span class="nb">false</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="n">def</span><span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">SelectiveStr</span><span class="o">&lt;</span><span class="nb">true</span><span class="o">&gt;</span><span class="w"> </span><span class="n">raw_schema</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">def</span><span class="p">(</span><span class="n">raw_schema</span><span class="p">.</span><span class="k">operator</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Func</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="n">def</span><span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">SelectiveStr</span><span class="o">&lt;</span><span class="nb">false</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="cm">/*raw_f*/</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Func</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="n">def</span><span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">SelectiveStr</span><span class="o">&lt;</span><span class="nb">true</span><span class="o">&gt;</span><span class="w"> </span><span class="n">raw_name_or_schema</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">raw_f</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">def</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">raw_name_or_schema</span><span class="p">.</span><span class="k">operator</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="p">(),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&gt;</span><span class="p">(</span><span class="n">raw_f</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Func</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="n">impl</span><span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">SelectiveStr</span><span class="o">&lt;</span><span class="nb">false</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="cm">/*raw_f*/</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Dispatch</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">Func</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="n">impl</span><span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">SelectiveStr</span><span class="o">&lt;</span><span class="nb">false</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Dispatch</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="cm">/*key*/</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="cm">/*raw_f*/</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Func</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="n">impl_UNBOXED</span><span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">SelectiveStr</span><span class="o">&lt;</span><span class="nb">false</span><span class="o">&gt;</span><span class="w"> </span><span class="cm">/*name*/</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="o">*</span><span class="w"> </span><span class="cm">/*raw_f*/</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">static_assert</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">c10</span><span class="o">::</span><span class="n">guts</span><span class="o">::</span><span class="n">false_t</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;.impl_UNBOXED(...) was removed. Please use .impl(...) instead.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Func</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="n">impl</span><span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">SelectiveStr</span><span class="o">&lt;</span><span class="nb">true</span><span class="o">&gt;</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">raw_f</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">impl</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="k">operator</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="p">(),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&gt;</span><span class="p">(</span><span class="n">raw_f</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Dispatch</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">Func</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="n">impl</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">detail</span><span class="o">::</span><span class="n">SelectiveStr</span><span class="o">&lt;</span><span class="nb">true</span><span class="o">&gt;</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">Dispatch</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">Func</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">raw_f</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">impl</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">name</span><span class="p">.</span><span class="k">operator</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Dispatch</span><span class="o">&gt;</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&gt;</span><span class="p">(</span><span class="n">raw_f</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Func</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="n">impl_UNBOXED</span><span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">SelectiveStr</span><span class="o">&lt;</span><span class="nb">true</span><span class="o">&gt;</span><span class="w"> </span><span class="cm">/*name*/</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="o">*</span><span class="w"> </span><span class="cm">/*raw_f*/</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">static_assert</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">c10</span><span class="o">::</span><span class="n">guts</span><span class="o">::</span><span class="n">false_t</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;.impl_UNBOXED(...) was removed. Please use .impl(...) instead.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Func</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="n">fallback</span><span class="p">(</span><span class="n">Func</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">raw_f</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">CppFunction</span><span class="w"> </span><span class="nf">f</span><span class="p">((</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&gt;</span><span class="p">(</span><span class="n">raw_f</span><span class="p">)));</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">_fallback</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">f</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">CurClass</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="kr">inline</span><span class="w"> </span><span class="n">torch</span><span class="o">::</span><span class="n">class_</span><span class="o">&lt;</span><span class="n">CurClass</span><span class="o">&gt;</span><span class="w"> </span><span class="n">class_</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">className</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="c1">// These overloads enable the use of selective build on classes registered</span>
<span class="w">  </span><span class="c1">// within a library. The API is the same as before with 1 minor change.</span>
<span class="w">  </span><span class="c1">// Instead of m.class_&lt;foo&gt;(&quot;foo&quot;) you instead do</span>
<span class="w">  </span><span class="c1">// m.class_&lt;foo&gt;(TORCH_SELECTIVE_CLASS(&quot;foo&quot;))</span>
<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">CurClass</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="kr">inline</span><span class="w"> </span><span class="n">torch</span><span class="o">::</span><span class="n">class_</span><span class="o">&lt;</span><span class="n">CurClass</span><span class="o">&gt;</span><span class="w"> </span><span class="n">class_</span><span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">SelectiveStr</span><span class="o">&lt;</span><span class="nb">true</span><span class="o">&gt;</span><span class="w"> </span><span class="n">className</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">CurClass</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="kr">inline</span><span class="w"> </span><span class="n">detail</span><span class="o">::</span><span class="n">ClassNotSelected</span><span class="w"> </span><span class="n">class_</span><span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">SelectiveStr</span><span class="o">&lt;</span><span class="nb">false</span><span class="o">&gt;</span><span class="w"> </span><span class="n">className</span><span class="p">);</span><span class="w"></span>

<span class="w"> </span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="n">Kind</span><span class="w"> </span><span class="n">kind_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">c10</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ns_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">c10</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">c10</span><span class="o">::</span><span class="n">DispatchKey</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dispatch_key_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">file_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">line_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">c10</span><span class="o">::</span><span class="n">RegistrationHandleRAII</span><span class="o">&gt;</span><span class="w"> </span><span class="n">registrars_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">friend</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">detail</span><span class="o">::</span><span class="n">TorchLibraryInit</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Non-user visible actual implementations of functions.  These aren&#39;t</span>
<span class="w">  </span><span class="c1">// public because we only implement &amp; qualifier and not &amp;&amp; qualifier</span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="nf">_def</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">c10</span><span class="o">::</span><span class="n">FunctionSchema</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">schema</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">c10</span><span class="o">::</span><span class="n">OperatorName</span><span class="o">*</span><span class="w"> </span><span class="n">out_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">at</span><span class="o">::</span><span class="n">Tag</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{},</span><span class="w"></span>
<span class="w">      </span><span class="n">_RegisterOrVerify</span><span class="w"> </span><span class="n">rv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_RegisterOrVerify</span><span class="o">::</span><span class="n">REGISTER</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="nf">_def</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">c10</span><span class="o">::</span><span class="n">either</span><span class="o">&lt;</span><span class="n">c10</span><span class="o">::</span><span class="n">OperatorName</span><span class="p">,</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">FunctionSchema</span><span class="o">&gt;&amp;&amp;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">CppFunction</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="nf">_impl</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">CppFunction</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">_RegisterOrVerify</span><span class="w"> </span><span class="n">rv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_RegisterOrVerify</span><span class="o">::</span><span class="n">REGISTER</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="o">&amp;</span><span class="w"> </span><span class="nf">_fallback</span><span class="p">(</span><span class="n">CppFunction</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">at</span><span class="o">::</span><span class="n">OperatorName</span><span class="w"> </span><span class="nf">_parseNameForLib</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">name_str</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">detail</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">TorchLibraryInit</span><span class="w"> </span><span class="k">final</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w"> </span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="n">InitFn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">void</span><span class="p">(</span><span class="n">Library</span><span class="o">&amp;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">Library</span><span class="w"> </span><span class="n">lib_</span><span class="p">;</span><span class="w"></span>

<span class="w"> </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="n">TorchLibraryInit</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">Library</span><span class="o">::</span><span class="n">Kind</span><span class="w"> </span><span class="n">kind</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">InitFn</span><span class="o">*</span><span class="w"> </span><span class="n">fn</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">ns</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">c10</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">c10</span><span class="o">::</span><span class="n">DispatchKey</span><span class="o">&gt;</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">line</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="n">lib_</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="w"> </span><span class="n">ns</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">fn</span><span class="p">(</span><span class="n">lib_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="p">}</span><span class="w"> </span><span class="c1">// namespace detail</span>

<span class="p">}</span><span class="w"> </span><span class="c1">// namespace torch</span>

<span class="c1">// NB: The EXACT NAMING of the initializer functions (e.g.,</span>
<span class="c1">// TORCH_LIBRARY_init_aten) matters for the code analyzer;</span>
<span class="c1">// see the regexes at tools/code_analyzer/run_analyzer.sh</span>

<span class="cp">#define TORCH_LIBRARY(ns, m)                                                   \</span>
<span class="cp">  static void TORCH_LIBRARY_init_##ns(torch::Library&amp;);                        \</span>
<span class="cp">  static const torch::detail::TorchLibraryInit TORCH_LIBRARY_static_init_##ns( \</span>
<span class="cp">      torch::Library::DEF,                                                     \</span>
<span class="cp">      &amp;TORCH_LIBRARY_init_##ns,                                                \</span>
<span class="cp">      #ns,                                                                     \</span>
<span class="cp">      c10::nullopt,                                                            \</span>
<span class="cp">      __FILE__,                                                                \</span>
<span class="cp">      __LINE__);                                                               \</span>
<span class="cp">  void TORCH_LIBRARY_init_##ns(torch::Library&amp; m)</span>

<span class="cp">#define TORCH_LIBRARY_FRAGMENT(ns, m) _TORCH_LIBRARY_FRAGMENT(ns, m, C10_UID)</span>

<span class="cp">#define _TORCH_LIBRARY_FRAGMENT(ns, m, uid)                       \</span>
<span class="cp">  static void C10_CONCATENATE(                                    \</span>
<span class="cp">      TORCH_LIBRARY_FRAGMENT_init_##ns##_, uid)(torch::Library&amp;); \</span>
<span class="cp">  static const torch::detail::TorchLibraryInit C10_CONCATENATE(   \</span>
<span class="cp">      TORCH_LIBRARY_FRAGMENT_static_init_##ns##_, uid)(           \</span>
<span class="cp">      torch::Library::FRAGMENT,                                   \</span>
<span class="cp">      &amp;C10_CONCATENATE(TORCH_LIBRARY_FRAGMENT_init_##ns##_, uid), \</span>
<span class="cp">      #ns,                                                        \</span>
<span class="cp">      c10::nullopt,                                               \</span>
<span class="cp">      __FILE__,                                                   \</span>
<span class="cp">      __LINE__);                                                  \</span>
<span class="cp">  void C10_CONCATENATE(                                           \</span>
<span class="cp">      TORCH_LIBRARY_FRAGMENT_init_##ns##_, uid)(torch::Library &amp; m)</span>

<span class="c1">// NB: if the dispatch key is not whitelisted, we simply omit the Library</span>
<span class="c1">// call entirely</span>
<span class="cp">#define TORCH_LIBRARY_IMPL(ns, k, m) _TORCH_LIBRARY_IMPL(ns, k, m, C10_UID)</span>

<span class="cp">#define _TORCH_LIBRARY_IMPL(ns, k, m, uid)                             \</span>
<span class="cp">  static void C10_CONCATENATE(                                         \</span>
<span class="cp">      TORCH_LIBRARY_IMPL_init_##ns##_##k##_, uid)(torch::Library&amp;);    \</span>
<span class="cp">  static const torch::detail::TorchLibraryInit C10_CONCATENATE(        \</span>
<span class="cp">      TORCH_LIBRARY_IMPL_static_init_##ns##_##k##_, uid)(              \</span>
<span class="cp">      torch::Library::IMPL,                                            \</span>
<span class="cp">      c10::guts::if_constexpr&lt;c10::impl::dispatch_key_allowlist_check( \</span>
<span class="cp">          c10::DispatchKey::k)&gt;(                                       \</span>
<span class="cp">          []() {                                                       \</span>
<span class="cp">            return &amp;C10_CONCATENATE(                                   \</span>
<span class="cp">                TORCH_LIBRARY_IMPL_init_##ns##_##k##_, uid);           \</span>
<span class="cp">          },                                                           \</span>
<span class="cp">          []() { return [](torch::Library&amp;) -&gt; void {}; }),            \</span>
<span class="cp">      #ns,                                                             \</span>
<span class="cp">      c10::make_optional(c10::DispatchKey::k),                         \</span>
<span class="cp">      __FILE__,                                                        \</span>
<span class="cp">      __LINE__);                                                       \</span>
<span class="cp">  void C10_CONCATENATE(                                                \</span>
<span class="cp">      TORCH_LIBRARY_IMPL_init_##ns##_##k##_, uid)(torch::Library &amp; m)</span>

<span class="c1">// These are variants of the macros above which are to be used for testing (they</span>
<span class="c1">// don&#39;t setup the static initializer, so you can control the visibility of</span>
<span class="c1">// the allocated library yourself).</span>
<span class="c1">//</span>
<span class="c1">// DO NOT use these in production code, they are NOT understood by the</span>
<span class="c1">// code analyzer and will be incorrectly analyzed in those situations.</span>

<span class="cp">#define MAKE_TORCH_LIBRARY(ns) \</span>
<span class="cp">  torch::Library(torch::Library::DEF, #ns, c10::nullopt, __FILE__, __LINE__)</span>
<span class="cp">#define MAKE_TORCH_LIBRARY_IMPL(ns, k)         \</span>
<span class="cp">  torch::Library(                              \</span>
<span class="cp">      torch::Library::IMPL,                    \</span>
<span class="cp">      #ns,                                     \</span>
<span class="cp">      c10::make_optional(c10::DispatchKey::k), \</span>
<span class="cp">      __FILE__,                                \</span>
<span class="cp">      __LINE__)</span>

<span class="c1">// Make the custom class API visible, so it is available from</span>
<span class="c1">// torch::Library.</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;torch/custom_class.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
</div>


             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, PyTorch Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              <ul>
<li><a class="reference internal" href="#">Program Listing for File library.h</a></li>
</ul>

            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
         <script src="../_static/jquery.js"></script>
         <script src="../_static/underscore.js"></script>
         <script src="../_static/doctools.js"></script>
         <script src="../_static/language_data.js"></script>
         <script src="../_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
         <script src="../_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
     

  

  <script type="text/javascript" src="../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">Stay up to date</li>
            <li><a href="https://www.facebook.com/pytorch" target="_blank">Facebook</a></li>
            <li><a href="https://twitter.com/pytorch" target="_blank">Twitter</a></li>
            <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
            <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">LinkedIn</a></li>
          </ul>  
          </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">PyTorch Podcasts</li>
            <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
            <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">Apple</a></li>
            <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">Google</a></li>
            <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">Amazon</a></li>
          </ul>
         </div>
        </div>
        
        <div class="privacy-policy">
          <ul>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">Terms</a></li>
            <li class="privacy-policy-links">|</li>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">Privacy</a></li>
          </ul>
        </div>
        <div class="copyright">
        <p>© Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation.
          For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see
          <a href="www.linuxfoundation.org/policies/">www.linuxfoundation.org/policies/</a>. The PyTorch Foundation supports the PyTorch open source
          project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC,
          please see <a href="www.lfprojects.org/policies/">www.lfprojects.org/policies/</a>.</p>
      </div>
     </div>

  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>
            
          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title" class="active">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/audio/stable/index.html">torchaudio</a>
            </li>

            <li>
              <a href="https://pytorch.org/text/stable/index.html">torchtext</a>
            </li>

            <li>
              <a href="https://pytorch.org/vision/stable/index.html">torchvision</a>
            </li>

            <li>
              <a href="https://pytorch.org/torcharrow">torcharrow</a>
            </li>

            <li>
              <a href="https://pytorch.org/data">TorchData</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchrec">TorchRec</a>
            </li>

            <li>
              <a href="https://pytorch.org/serve/">TorchServe</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchx/">TorchX</a>
            </li>

            <li>
              <a href="https://pytorch.org/xla">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>
            
           <ul class="resources-mobile-menu-items">

            <li>
              <a href="https://pytorch.org/features">About</a>
            </li>

            <li>
              <a href="https://pytorch.org/foundation">PyTorch Foundation</a>
            </li>

            <li>
              <a href="https://pytorch.org/#community-module">Community</a>
            </li>

            <li>
              <a href="https://pytorch.org/community-stories">Community Stories</a>
            </li>

            <li>
              <a href="https://pytorch.org/resources">Developer Resources</a>
            </li>

            <li>
              <a href="https://pytorch.org/events">Events</a>
            </li>

            <li>
              <a href="https://discuss.pytorch.org/">Forums</a>
            </li>

            <li>
              <a href="https://pytorch.org/hub">Models (Beta)</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>