


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Program Listing for File chunk.h &mdash; PyTorch master documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://pytorch.org/docs/stable/api/program_listing_file_torch_csrc_api_include_torch_data_datasets_chunk.h.html"/>
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../_static/cpp_theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/collapsible-lists/css/tree_view.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <!-- Google Analytics -->
  
  <!-- End Google Analytics -->
  

  
  <script src="../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="active docs-active">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/audio/stable/index.html">
                  <span class="dropdown-title">torchaudio</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/text/stable/index.html">
                  <span class="dropdown-title">torchtext</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/vision/stable/index.html">
                  <span class="dropdown-title">torchvision</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torcharrow">
                  <span class="dropdown-title">torcharrow</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/data">
                  <span class="dropdown-title">TorchData</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchrec">
                  <span class="dropdown-title">TorchRec</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/serve/">
                  <span class="dropdown-title">TorchServe</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchx/">
                  <span class="dropdown-title">TorchX</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/xla">
                  <span class="dropdown-title">PyTorch on XLA Devices</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about PyTorch’s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/foundation">
                  <span class="dropdown-title">PyTorch Foundation</span>
                  <p>Learn about the PyTorch foundation</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/community-stories">
                  <span class="dropdown-title">Community Stories</span>
                  <p>Learn how our community solves real, everyday machine learning problems with PyTorch.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/events">
                  <span class="dropdown-title">Events</span>
                  <p>Find events, webinars, and podcasts</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/hub">
                  <span class="dropdown-title">Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
                <div class="version">
                  master
                </div>
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../installing.html">Installing C++ Distributions of PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../frontend.html">The C++ Frontend</a></li>
<li class="toctree-l1"><a class="reference internal" href="library_root.html">Library API</a></li>
</ul>
<p class="caption"><span class="caption-text">Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../notes/faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/inference_mode.html">Inference Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/maybe_owned.html">MaybeOwned&lt;Tensor&gt;</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/tensor_basics.html">Tensor Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/tensor_creation.html">Tensor Creation API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/tensor_cuda_stream.html">Tensor CUDA Stream API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/tensor_indexing.html">Tensor Indexing API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/versioning.html">Library Versioning</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
      <li>Program Listing for File chunk.h</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
            
            
              <!-- User defined GitHub URL -->
              <a href="https://github.com/pytorch/pytorch" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <div class="section" id="program-listing-for-file-chunk-h">
<span id="program-listing-file-torch-csrc-api-include-torch-data-datasets-chunk-h"></span><h1>Program Listing for File chunk.h<a class="headerlink" href="#program-listing-for-file-chunk-h" title="Permalink to this headline">¶</a></h1>
<p>↰ <a class="reference internal" href="file_torch_csrc_api_include_torch_data_datasets_chunk.h.html#file-torch-csrc-api-include-torch-data-datasets-chunk-h"><span class="std std-ref">Return to documentation for file</span></a> (<code class="docutils literal notranslate"><span class="pre">torch/csrc/api/include/torch/data/datasets/chunk.h</span></code>)</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma once</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;c10/util/irange.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;torch/arg.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;torch/csrc/utils/memory.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;torch/data/datasets/stateful.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;torch/data/samplers.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;queue&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;thread&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;torch/serialize.h&gt;</span><span class="cp"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">data</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">datasets</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="w"></span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">ExampleType_</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">ChunkType_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ExampleType_</span><span class="o">&gt;&gt;</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">ChunkDataReader</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w"> </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">ChunkDataReader</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="n">ChunkType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ChunkType_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="n">ExampleType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ExampleType_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="n">ChunkType</span><span class="w"> </span><span class="nf">read_chunk</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">chunk_index</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="nf">chunk_count</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">reset</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">detail</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="w"></span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">UnwrappedBatch</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">ExampleSampler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">samplers</span><span class="o">::</span><span class="n">RandomSampler</span><span class="o">&gt;</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">BatchDataBuffer</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w"> </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="n">UnwrappedBatchType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnwrappedBatch</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="n">BatchType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">torch</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">UnwrappedBatchType</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="n">BatchRequestType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">ExampleSampler</span><span class="o">::</span><span class="n">BatchRequestType</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">BatchDataBuffer</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="kt">size_t</span><span class="w"> </span><span class="n">batch_size</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">ExampleSampler</span><span class="o">&amp;</span><span class="w"> </span><span class="n">example_sampler</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="kt">size_t</span><span class="w"> </span><span class="n">queue_capacity</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="n">batch_size_</span><span class="p">(</span><span class="n">batch_size</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">example_sampler_</span><span class="p">(</span><span class="n">example_sampler</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">queue_capacity_</span><span class="p">(</span><span class="n">queue_capacity</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="w">  </span><span class="n">BatchType</span><span class="w"> </span><span class="n">get_batch</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">queue_mutex_</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">cv_read_</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="k">this</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// wait till there is available data in the queue or if all chunks are</span>
<span class="w">      </span><span class="c1">// loaded (i.e. the dataset is exhausted for this epoch)</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">total_example_count_in_queue_</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">batch_size_</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">stop_</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">batch_queue_</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">AT_ASSERT</span><span class="p">(</span><span class="n">stop_</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="c1">// All batches have been retrieved. Return an empty batch.</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">nullopt</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">UnwrappedBatchData</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">batch_queue_</span><span class="p">.</span><span class="n">front</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">batch_queue_</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">batch</span><span class="p">.</span><span class="n">exception</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="n">WorkerException</span><span class="p">(</span><span class="n">batch</span><span class="p">.</span><span class="n">exception</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">total_example_count_in_queue_</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">batch</span><span class="p">.</span><span class="n">batch_data</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">lock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">cv_write_</span><span class="p">.</span><span class="n">notify_all</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">batch</span><span class="p">.</span><span class="n">batch_data</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">add_chunk_data</span><span class="p">(</span><span class="n">UnwrappedBatchType</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">queue_mutex_</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">cv_write_</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="k">this</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// stop loading if we have preloaded enough data.</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">total_example_count_in_queue_</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">queue_capacity_</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">stop_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stop_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// When stop_ is true, it means no further chunk loading is necessary.</span>
<span class="w">      </span><span class="c1">// Return without any further processing.</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">data_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">remaining_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data_size</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">example_sampler_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">data_size</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">fill_batch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="kt">size_t</span><span class="w"> </span><span class="n">example_count</span><span class="p">,</span><span class="w"> </span><span class="n">UnwrappedBatchType</span><span class="o">&amp;</span><span class="w"> </span><span class="n">batch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">batch_example_indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">example_sampler_</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="n">example_count</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">AT_ASSERT</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">batch_example_indices</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">          </span><span class="n">batch_example_indices</span><span class="p">.</span><span class="n">value</span><span class="p">().</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">example_count</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">BatchRequestType</span><span class="o">&amp;</span><span class="w"> </span><span class="n">indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">batch_example_indices</span><span class="p">.</span><span class="n">value</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">indices</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">TORCH_CHECK</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">data_size</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Index out of range&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">batch</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">remaining_size</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">example_count</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">batch_queue_</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// if the queue has existing data, and the last batch doesn&#39;t have enough</span>
<span class="w">      </span><span class="c1">// examples to fill a batch_size batch, add more example to this batch</span>
<span class="w">      </span><span class="c1">// first.</span>
<span class="w">      </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">batch_queue_</span><span class="p">.</span><span class="n">back</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="kt">size_t</span><span class="w"> </span><span class="n">current_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">batch</span><span class="p">.</span><span class="n">batch_data</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_count</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">batch_size_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">example_count</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">remaining_size</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size_</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">current_count</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">fill_batch</span><span class="p">(</span><span class="n">example_count</span><span class="p">,</span><span class="w"> </span><span class="n">batch</span><span class="p">.</span><span class="n">batch_data</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// If we still have data remaining after filling the last pushed batch, add</span>
<span class="w">    </span><span class="c1">// them to the queue too.</span>
<span class="w">    </span><span class="c1">// NOLINTNEXTLINE(bugprone-infinite-loop)</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">remaining_size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">UnwrappedBatchType</span><span class="w"> </span><span class="n">current_batch</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Allocate the batch memory ahead of time.</span>
<span class="w">      </span><span class="n">current_batch</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">batch_size_</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">example_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">remaining_size</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size_</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">fill_batch</span><span class="p">(</span><span class="n">example_count</span><span class="p">,</span><span class="w"> </span><span class="n">current_batch</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">batch_queue_</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">current_batch</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">total_example_count_in_queue_</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">data_size</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">lock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">cv_read_</span><span class="p">.</span><span class="n">notify_all</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">add_chunk_data</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">exception_ptr</span><span class="w"> </span><span class="n">e_ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">queue_mutex_</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">cv_write_</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="k">this</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// stop loading if we have preloaded enough data.</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">total_example_count_in_queue_</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">queue_capacity_</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">stop_</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stop_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// When stop_ is true, it means this current thread needs to be tore down,</span>
<span class="w">      </span><span class="c1">// the batch buffer will be discarded, so no need to enqueue any new</span>
<span class="w">      </span><span class="c1">// exceptions.</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">batch_queue_</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">e_ptr</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">lock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">cv_read_</span><span class="p">.</span><span class="n">notify_all</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">stop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// Hold the lock before changing stop_ to prevent a race condition which</span>
<span class="w">      </span><span class="c1">// can cause a deadlock. To be more specific, conditional variable</span>
<span class="w">      </span><span class="c1">// cv_write_ waits on predicate stop_ in add_chunk_data(). The wait</span>
<span class="w">      </span><span class="c1">// happens in two steps: 1) while still holding the lock, check if</span>
<span class="w">      </span><span class="c1">// predicate is true; 2) if it is true, proceeds, otherwise, release the</span>
<span class="w">      </span><span class="c1">// lock and wait until notified. Without holding a lock, cv_write_&#39;s</span>
<span class="w">      </span><span class="c1">// notification can happen in between step 1) and 2). In that case, as</span>
<span class="w">      </span><span class="c1">// cv_write_ is not in waiting status yet, so the notification is lost and</span>
<span class="w">      </span><span class="c1">// cv_write_ will sleep forever. By taking a lock before changing</span>
<span class="w">      </span><span class="c1">// predicate stop_, it is ensured updating and evaluating stop_ always</span>
<span class="w">      </span><span class="c1">// happen in a synchronized way</span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">queue_mutex_</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">stop_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// notify all writers, wake them from wait to exit current method.</span>
<span class="w">    </span><span class="n">cv_write_</span><span class="p">.</span><span class="n">notify_all</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="c1">// notify all readers too.</span>
<span class="w">    </span><span class="n">cv_read_</span><span class="p">.</span><span class="n">notify_all</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">batch_size_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">total_example_count_in_queue_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">UnwrappedBatchData</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">explicit</span><span class="w"> </span><span class="n">UnwrappedBatchData</span><span class="p">(</span><span class="n">UnwrappedBatchType</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">batch_data</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// NOLINTNEXTLINE(modernize-pass-by-value)</span>
<span class="w">    </span><span class="k">explicit</span><span class="w"> </span><span class="n">UnwrappedBatchData</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">exception_ptr</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="w">    </span><span class="n">UnwrappedBatchType</span><span class="w"> </span><span class="n">batch_data</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">exception_ptr</span><span class="w"> </span><span class="n">exception</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">};</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="o">&lt;</span><span class="n">UnwrappedBatchData</span><span class="o">&gt;</span><span class="w"> </span><span class="n">batch_queue_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// sync batch_queue_ update.</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="w"> </span><span class="n">queue_mutex_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span><span class="w"> </span><span class="n">cv_read_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span><span class="w"> </span><span class="n">cv_write_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">ExampleSampler</span><span class="o">&amp;</span><span class="w"> </span><span class="n">example_sampler_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// configurable maximun number of elements the queue can hold at one time.</span>
<span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">queue_capacity_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// When set to true, it wakes the writer threads from the wait and exit</span>
<span class="w">  </span><span class="c1">// current function call. This is needed when ChunkDataSet.Reset is called</span>
<span class="w">  </span><span class="c1">// while the previous epoch is not exhausted yet. When ChunkDataset is waiting</span>
<span class="w">  </span><span class="c1">// its preloader to finish previous work before tearing down the thread, the</span>
<span class="w">  </span><span class="c1">// preloader could be still waiting for the conditional variable, thus cause</span>
<span class="w">  </span><span class="c1">// the program to hang. This boolean is used to break this waiting condition.</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">stop_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="c1">// namespace detail</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">ChunkDatasetOptions</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">ChunkDatasetOptions</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">delete</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">ChunkDatasetOptions</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="kt">size_t</span><span class="w"> </span><span class="n">preloader_count</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="kt">size_t</span><span class="w"> </span><span class="n">batch_size</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="kt">size_t</span><span class="w"> </span><span class="n">cache_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2048</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="kt">size_t</span><span class="w"> </span><span class="n">cross_chunk_shuffle_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="n">preloader_count_</span><span class="p">(</span><span class="n">preloader_count</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">batch_size_</span><span class="p">(</span><span class="n">batch_size</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">cache_size_</span><span class="p">(</span><span class="n">cache_size</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">cross_chunk_shuffle_count_</span><span class="p">(</span><span class="n">cross_chunk_shuffle_count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">TORCH_CHECK</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">preloader_count_</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;Preloader count is 0. At least one preloader needs to be specified.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">TORCH_CHECK</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">batch_size_</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;Batch size is 0. A positive batch size needs to be specified.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">TORCH_CHECK</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">cache_size_</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;Cache size is 0. A positive cache size needs to be specified.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">TORCH_CHECK</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">cache_size_</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">batch_size_</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;Cache size is less than batch size. Cache needs to be large enough to &quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;hold at least one batch.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">TORCH_CHECK</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">cross_chunk_shuffle_count_</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;cross_chunk_shuffle_count needs to be greater than 0.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">TORCH_ARG</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">preloader_count</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">TORCH_ARG</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">TORCH_ARG</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">cache_size</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2048</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// The number of chunks to perfrom cross-chunk shuffling. Default to 1 meaning</span>
<span class="w">  </span><span class="c1">// no cross-chunk shuffling. When it is equal to n (n &gt; 1), n random</span>
<span class="w">  </span><span class="c1">// chunks will be loaded at once and example shuffling will be performed</span>
<span class="w">  </span><span class="c1">// across all those n chunks.</span>
<span class="w">  </span><span class="c1">// Note: Usually the default config (1 chunk shuffle + example shuffle) is</span>
<span class="w">  </span><span class="c1">// good enough to generate random distributed data. Use this parameter only if</span>
<span class="w">  </span><span class="c1">// you know cross-shuffle is needed in your case. Also there is a performance</span>
<span class="w">  </span><span class="c1">// penalty when this value is greater than 1, as we need to do extra merge</span>
<span class="w">  </span><span class="c1">// between multiple chunks before performing example sampling.</span>
<span class="w">  </span><span class="n">TORCH_ARG</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">cross_chunk_shuffle_count</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="w"></span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">ChunkReader</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">ChunkSampler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">samplers</span><span class="o">::</span><span class="n">RandomSampler</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">ExampleSampler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">samplers</span><span class="o">::</span><span class="n">RandomSampler</span><span class="o">&gt;</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">ChunkDataset</span><span class="w"> </span><span class="k">final</span><span class="w"></span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">StatefulDataset</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">          </span><span class="n">ChunkDataset</span><span class="o">&lt;</span><span class="n">ChunkReader</span><span class="p">,</span><span class="w"> </span><span class="n">ChunkSampler</span><span class="p">,</span><span class="w"> </span><span class="n">ExampleSampler</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="k">typename</span><span class="w"> </span><span class="nc">ChunkReader</span><span class="o">::</span><span class="n">BatchType</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w"> </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="n">BatchType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">torch</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">ChunkReader</span><span class="o">::</span><span class="n">BatchType</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="n">UnwrappedBatchType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">ChunkReader</span><span class="o">::</span><span class="n">BatchType</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="n">BatchRequestType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">size_t</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="n">ChunkSamplerType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ChunkSampler</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="n">ExampleSamplerType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ExampleSampler</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">ChunkDataset</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">ChunkReader</span><span class="w"> </span><span class="n">chunk_reader</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">ChunkSampler</span><span class="w"> </span><span class="n">chunk_sampler</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">ExampleSampler</span><span class="w"> </span><span class="n">example_sampler</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">ChunkDatasetOptions</span><span class="w"> </span><span class="n">options</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">UnwrappedBatchType</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">preprocessing_policy</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">UnwrappedBatchType</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="n">chunk_reader_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">chunk_reader</span><span class="p">)),</span><span class="w"></span>
<span class="w">        </span><span class="n">chunk_sampler_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">chunk_sampler</span><span class="p">)),</span><span class="w"></span>
<span class="w">        </span><span class="n">example_sampler_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">example_sampler</span><span class="p">)),</span><span class="w"></span>
<span class="w">        </span><span class="n">options_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">options</span><span class="p">)),</span><span class="w"></span>
<span class="w">        </span><span class="n">preprocessing_policy_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">preprocessing_policy</span><span class="p">)),</span><span class="w"></span>
<span class="w">        </span><span class="n">quit_worker_</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">running_preloaders_</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">load_checkpoint_</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="w">  </span><span class="o">~</span><span class="n">ChunkDataset</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// stop batch buffer first.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">batch_buffer_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">batch_buffer_</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">free_workers</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">BatchType</span><span class="w"> </span><span class="n">get_batch</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">batch_size</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">TORCH_CHECK</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">batch_buffer_</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;Dataset needs to call reset() before calling get_batch().&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">TORCH_CHECK</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">batch_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">options_</span><span class="p">.</span><span class="n">batch_size</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;The requested batch size does not match with the initialized batch size.</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot; The requested batch size is &quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">batch_size</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;, while the dataset is created with batch size equal to &quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">options_</span><span class="p">.</span><span class="n">batch_size</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">batch_buffer_</span><span class="o">-&gt;</span><span class="n">get_batch</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">BatchType</span><span class="w"> </span><span class="n">get_batch</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">get_batch</span><span class="p">(</span><span class="n">options_</span><span class="p">.</span><span class="n">batch_size</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">reset</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// We need this to support partial data reads via dataloader iterator.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">batch_buffer_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">batch_buffer_</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// free workers from previous reset if there is any.</span>
<span class="w">    </span><span class="n">free_workers</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">preload_threads_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">load_checkpoint_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">chunk_reader_</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">chunk_sampler_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">chunk_reader_</span><span class="p">.</span><span class="n">chunk_count</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">load_checkpoint_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Throw out any existing cached batch in the buffer and re-creates a new</span>
<span class="w">    </span><span class="c1">// chunk buffer.</span>
<span class="w">    </span><span class="n">batch_buffer_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">torch</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">        </span><span class="n">detail</span><span class="o">::</span><span class="n">BatchDataBuffer</span><span class="o">&lt;</span><span class="n">UnwrappedBatchType</span><span class="p">,</span><span class="w"> </span><span class="n">ExampleSamplerType</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">options_</span><span class="p">.</span><span class="n">batch_size</span><span class="p">(),</span><span class="w"> </span><span class="n">example_sampler_</span><span class="p">,</span><span class="w"> </span><span class="n">options_</span><span class="p">.</span><span class="n">cache_size</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="c1">// create new workers for this new epoch.</span>
<span class="w">    </span><span class="n">quit_worker_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">AT_ASSERT</span><span class="p">(</span><span class="n">running_preloaders_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">running_preloaders_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options_</span><span class="p">.</span><span class="n">preloader_count</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">irange</span><span class="p">(</span><span class="n">options_</span><span class="p">.</span><span class="n">preloader_count</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">preload_threads_</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">preloader</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">optional</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">torch</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// provide a references to chunk sampler. Used mainly in distributed data</span>
<span class="w">  </span><span class="c1">// loading to set the epoch number for the sampler.</span>
<span class="w">  </span><span class="n">ChunkSamplerType</span><span class="o">&amp;</span><span class="w"> </span><span class="n">chunk_sampler</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">chunk_sampler_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">save</span><span class="p">(</span><span class="n">serialize</span><span class="o">::</span><span class="n">OutputArchive</span><span class="o">&amp;</span><span class="w"> </span><span class="n">archive</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">chunk_index_guard_</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">chunk_sampler_</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">archive</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">load</span><span class="p">(</span><span class="n">serialize</span><span class="o">::</span><span class="n">InputArchive</span><span class="o">&amp;</span><span class="w"> </span><span class="n">archive</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">chunk_index_guard_</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">chunk_sampler_</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">archive</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">load_checkpoint_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w"> </span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">preloader</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">quit_worker_</span><span class="p">.</span><span class="n">load</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">chunk_idx</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">chunk_index_guard_</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">chunk_sampler_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk_sampler_</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">options_</span><span class="p">.</span><span class="n">cross_chunk_shuffle_count</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">chunk_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk_sampler_result</span><span class="p">.</span><span class="n">value</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">UnwrappedBatchType</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk_reader_</span><span class="p">.</span><span class="n">read_chunk</span><span class="p">(</span><span class="n">chunk_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">c10</span><span class="o">::</span><span class="n">irange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">chunk_idx</span><span class="p">.</span><span class="n">size</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">chunk_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk_reader_</span><span class="p">.</span><span class="n">read_chunk</span><span class="p">(</span><span class="n">chunk_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">chunk_data</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">chunk_data</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">back_inserter</span><span class="p">(</span><span class="n">data</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">preprocessing_policy_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">preprocessing_policy_</span><span class="p">(</span><span class="n">data</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// skip empty chunks.</span>
<span class="w">          </span><span class="n">batch_buffer_</span><span class="o">-&gt;</span><span class="n">add_chunk_data</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">data</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(...)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">batch_buffer_</span><span class="o">-&gt;</span><span class="n">add_chunk_data</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">current_exception</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">AT_ASSERT</span><span class="p">(</span><span class="n">running_preloaders_</span><span class="p">.</span><span class="n">load</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="o">--</span><span class="n">running_preloaders_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">running_preloaders_</span><span class="p">.</span><span class="n">load</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// all preloaders are completed, so we can notify the batch_buffer.</span>
<span class="w">      </span><span class="n">batch_buffer_</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">free_workers</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">quit_worker_</span><span class="p">.</span><span class="n">load</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">quit_worker_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">worker_thread</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">preload_threads_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">worker_thread</span><span class="p">.</span><span class="n">join</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w"> </span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Templated class that defines what is a chunk and how to read chunk data.</span>
<span class="w">  </span><span class="c1">// When a chunk is returned by chunk_reader_, ChunkDataset split it into</span>
<span class="w">  </span><span class="c1">// batches and caches them in batch_buffer_.</span>
<span class="w">  </span><span class="n">ChunkReader</span><span class="w"> </span><span class="n">chunk_reader_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// chunk sampler to shuffle different chunks</span>
<span class="w">  </span><span class="n">ChunkSamplerType</span><span class="w"> </span><span class="n">chunk_sampler_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// example sampler to shuffle examples in a specific chunk</span>
<span class="w">  </span><span class="n">ExampleSamplerType</span><span class="w"> </span><span class="n">example_sampler_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// batch data buffer which holds chunk data from preloading thread.</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">      </span><span class="n">detail</span><span class="o">::</span><span class="n">BatchDataBuffer</span><span class="o">&lt;</span><span class="n">UnwrappedBatchType</span><span class="p">,</span><span class="w"> </span><span class="n">ExampleSamplerType</span><span class="o">&gt;&gt;</span><span class="w"></span>
<span class="w">      </span><span class="n">batch_buffer_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// worker thread pool</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span><span class="w"> </span><span class="n">preload_threads_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">ChunkDatasetOptions</span><span class="w"> </span><span class="n">options_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// function pointer wrapper to apply custom processing over chunk data. This</span>
<span class="w">  </span><span class="c1">// is considered an advanced parameter for developers who want to apply a</span>
<span class="w">  </span><span class="c1">// pre-process to the chunk data before sampling into minibatch.</span>
<span class="w">  </span><span class="c1">// Different than the collate function, this policy is applied on the chunk</span>
<span class="w">  </span><span class="c1">// level, instead of minibatch level. When a chunk of data is loaded (multiple</span>
<span class="w">  </span><span class="c1">// chunks if cross_chunk_shuffle_count_ is greater than 1), this policy is</span>
<span class="w">  </span><span class="c1">// applied to the full loaded data. It is useful if developers want to</span>
<span class="w">  </span><span class="c1">// perform pre-processing (like bucketing) to the chunk data before</span>
<span class="w">  </span><span class="c1">// example sampler samples the data. By default it&#39;s an empty pointer and no</span>
<span class="w">  </span><span class="c1">// action will be taken.</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">UnwrappedBatchType</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">preprocessing_policy_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// indicate whether the worker thread can be teared down</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">quit_worker_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// keep track of running preloaders to notify batch buffer. A value 0</span>
<span class="w">  </span><span class="c1">// indicates that the chunk loading is completed.</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">running_preloaders_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// mutex to synchronize chunk sampler next() call.</span>
<span class="w">  </span><span class="k">mutable</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="w"> </span><span class="n">chunk_index_guard_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// boolean value to indicate whether we need to load the checkpoint for</span>
<span class="w">  </span><span class="c1">// chunk_sampler_.</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">load_checkpoint_</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="c1">// namespace datasets</span>
<span class="p">}</span><span class="w"> </span><span class="c1">// namespace data</span>
<span class="p">}</span><span class="w"> </span><span class="c1">// namespace torch</span>
</pre></div>
</div>
</div>


             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, PyTorch Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              <ul>
<li><a class="reference internal" href="#">Program Listing for File chunk.h</a></li>
</ul>

            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
         <script src="../_static/jquery.js"></script>
         <script src="../_static/underscore.js"></script>
         <script src="../_static/doctools.js"></script>
         <script src="../_static/language_data.js"></script>
         <script src="../_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
         <script src="../_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
     

  

  <script type="text/javascript" src="../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">Stay up to date</li>
            <li><a href="https://www.facebook.com/pytorch" target="_blank">Facebook</a></li>
            <li><a href="https://twitter.com/pytorch" target="_blank">Twitter</a></li>
            <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
            <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">LinkedIn</a></li>
          </ul>  
          </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">PyTorch Podcasts</li>
            <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
            <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">Apple</a></li>
            <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">Google</a></li>
            <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">Amazon</a></li>
          </ul>
         </div>
        </div>
        
        <div class="privacy-policy">
          <ul>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">Terms</a></li>
            <li class="privacy-policy-links">|</li>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">Privacy</a></li>
          </ul>
        </div>
        <div class="copyright">
        <p>© Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation.
          For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see
          <a href="www.linuxfoundation.org/policies/">www.linuxfoundation.org/policies/</a>. The PyTorch Foundation supports the PyTorch open source
          project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC,
          please see <a href="www.lfprojects.org/policies/">www.lfprojects.org/policies/</a>.</p>
      </div>
     </div>

  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>
            
          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title" class="active">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/audio/stable/index.html">torchaudio</a>
            </li>

            <li>
              <a href="https://pytorch.org/text/stable/index.html">torchtext</a>
            </li>

            <li>
              <a href="https://pytorch.org/vision/stable/index.html">torchvision</a>
            </li>

            <li>
              <a href="https://pytorch.org/torcharrow">torcharrow</a>
            </li>

            <li>
              <a href="https://pytorch.org/data">TorchData</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchrec">TorchRec</a>
            </li>

            <li>
              <a href="https://pytorch.org/serve/">TorchServe</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchx/">TorchX</a>
            </li>

            <li>
              <a href="https://pytorch.org/xla">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>
            
           <ul class="resources-mobile-menu-items">

            <li>
              <a href="https://pytorch.org/features">About</a>
            </li>

            <li>
              <a href="https://pytorch.org/foundation">PyTorch Foundation</a>
            </li>

            <li>
              <a href="https://pytorch.org/#community-module">Community</a>
            </li>

            <li>
              <a href="https://pytorch.org/community-stories">Community Stories</a>
            </li>

            <li>
              <a href="https://pytorch.org/resources">Developer Resources</a>
            </li>

            <li>
              <a href="https://pytorch.org/events">Events</a>
            </li>

            <li>
              <a href="https://discuss.pytorch.org/">Forums</a>
            </li>

            <li>
              <a href="https://pytorch.org/hub">Models (Beta)</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>